# Laboratoire 21

<center>![BanniÃ¨re dÃ©corative](../../static/img/labo21/banner.png)</center>

C'est le dernier laboratoire ! ğŸ˜­ TÃ©lÃ©chargez les [projets de dÃ©part](../../static/files/labo21.zip) en sÃ©chant vos larmes ğŸ’¦

## ğŸ˜© Jeu de rÃ´les

### 1 - CrÃ©er des rÃ´les

[ğŸ’¡](/cours/rencontre11.1#-crÃ©er-un-rÃ´le) CrÃ©er deux rÃ´les nommÃ©s **student** et **corruptedTeacher** dans le seed.

### 2 - Attribuer des rÃ´les

[ğŸ’¡](/cours/rencontre11.1#-crÃ©er-un-rÃ´le) Toujours dans le seed, attribuez le rÃ´le **student** Ã  **Pielle-Arexandre** et Ã  **Masie-Carrandra**.
De plus, attribuez le rÃ´le **corruptedTeacher** Ã  **maxou**.

### 3 - Limiter l'accÃ¨s Ã  des actions

[ğŸ’¡](/cours/rencontre11.1#-limiter-laccÃ¨s-aux-actions) L'action `PostReview`Â doit seulement Ãªtre utilisable par des **student**. De plus, l'action `DeleteReview` doit seulement Ãªtre utilisable par **l'auteur d'un review OU par un corruptedTeacher**. (Un **corruptedTeacher** peut supprimer tous les reviews et un **student** peut seulement supprimer ses propres reviews.)

Assurez-vous de bien tester toutes ces nouvelles contraintes et n'hÃ©sitez pas Ã  crÃ©er de nouveaux utilisateurs sans rÃ´le en vous inscrivant.

<center>
|Utilisateur|Mot de passe|RÃ´le|
|-|-|-|
|maxou|allo|corruptedTeacher|
|Pielle-Arexandre|allo|student|
|Masie-Carrandra|allo|student|
</center>

## ğŸ“œ Qui suis-je ?

L'objectif de cette section sera afficher les donnÃ©es de l'utilisateur cÃ´tÃ© Angular. Comme le modÃ¨le `User` n'existe pas cÃ´tÃ© client et qu'on n'a pas accÃ¨s Ã  la base de donnÃ©es et aux rÃ´les, il faudra Ãªtre un peu crÃ©atif. (Mais pas beaucoup)

<center>![Profil de l'utilisateur](../../static/img/labo21/profile.png)</center>

### 4 - Modifier la connexion

CÃ´tÃ© serveur, dans l'action `Login`, ajoutez deux choses dans **l'objet JSON qui contient le token** :

* Le pseudonyme de l'utilisateur.
* La liste de strings avec tous les rÃ´les de l'utilisateur.

Ces deux informations ne sont pas censÃ©es Ãªtre difficiles Ã  trouver dans le code existant.

### 5 - Afficher le profil

CÃ´tÃ© Angular, dans le `ReviewService`, sous la requÃªte `Login`, on va maintenant attraper ces deux nouvelles informations. Avant de faire Ã§a, nous allons prÃ©parer des variables dans le `ReviewService` pour **stocker le pseudo et le(s) rÃ´le(s)** de l'utilisateur prÃ©sentement connectÃ©.

[ğŸ’¡](/cours/rencontre11.1#-signal-pour-plusieurs-composants) CrÃ©ez deux paires de signaux (la version composÃ©e d'un signal modifiable **privÃ©** + un signal non-modifiable) :

* Un signal privÃ© de type `string|null` initialisÃ© avec la valeur `null`.
* Un signal privÃ© de type `string[]` initialisÃ© avec un tableau vide `[]`.

N'oubliez pas de crÃ©er les signaux non-modifiables associÃ©s ! (Comme Ã§a on pourra accÃ©der Ã  ces valeurs en dehors du service)

ğŸ’¾ Toujours dans le `ReviewService`, dans la fonction `Login()`, en plus du **token** qui est dÃ©jÃ  stockÃ© dans le stockage local :

* Stockez le pseudo de l'utilisateur **dans le stockage local** ET **dans le signal de type `string|null`**.
* Stockez les rÃ´les de l'utilisateur **dans le stockage local** ET **dans le signal de type `string[]`**.

:::warning

[ğŸ’¡](/cours/rencontre4.1#-sauvegarder-une-donnÃ©e-dun-autre-type-que-string) Comme la liste des rÃ´les **n'est pas un `string`**, N'oubliez pas d'utiliser `JSON.parse(...)`.

:::

âœ Modifiez le HTML de `AppComponent` ... :

* Affichez le pseudo de l'utilisateur connectÃ© Ã  l'aide du bon signal.
* Affichez les rÃ´les de l'utilisateur connectÃ© Ã  l'aide du bon signal. (Pas besoin de `*ngFor`)
* Cacher toute la boÃ®te du profil lorsque le pseudo de l'utilisateur est `null`.

:::note

HÃ©las, ce fonctionnement est brisÃ© si on rÃ©actualise la page. Pas de panique : c'est pour Ã§a qu'on a stockÃ© le pseudo et les rÃ´les dans le **stockage local** !

:::

âš™ Ajoutez les deux fonctions suivantes dans votre `ReviewService`. Elles permettront au `AppComponent` de modifier les valeurs des signaux :

```ts showLineNumbers
setUsername(username : string | null){
    this.SIGNAL_DU_PSEUDO.set(username);
}

setRoles(roles : string[]){
    this.SIGNAL_DES_ROLES.set(roles);
}
```

â° Finalement, modifiez la fonction `ngOnInit()` dans le `AppComponent` pour qu'elle :

* RÃ©cupÃ¨re le pseudo et les rÃ´les, qui sont dans le **stockage local**.
* Modifie les signaux pour indiquer le pseudo et les rÃ´les Ã  l'aide des deux fonctions qu'on vient d'ajouter.

DÃ©sormais, le panneau du profil devrait Ãªtre fonctionnel en tout temps, mÃªme si on rÃ©actualise la page : 

<center>![Profil de l'utilisateur](../../static/img/labo21/profile.png)</center>

ğŸ”Œ Un dernier dÃ©tail important : la dÃ©connexion ! Modifiez la fonction `logout()` dans le `ReviewService` :

* Elle doit supprimer le **token**, le **pseudo** et les **rÃ´les** du stockage local.
* Elle doit rÃ©initialiser les signaux avec les valeurs `null` et `[]`.

Assurez-vous qu'en vous dÃ©connectant, le panneau du profil devienne invisible.

## ğŸ‘€ Ce qu'on ne voit pas ne nous fait pas de mal

### 6 - Cacher des Ã©lÃ©ments selon le profil

Ã€ l'aide de `*ngIf` et des **signaux** qu'on a crÃ©Ã©s, vous devrez cacher certains Ã©lÃ©ments dans la page Web.

<center>![CrÃ©er un review](../../static/img/labo21/studentOnly.png)</center>

ğŸ“ La zone pour crÃ©er un `Review` doit seulement Ãªtre visible pour les utilisateurs avec le rÃ´le `student`. (L'instruction en JavaScript `monTableau.includes(valeur)`, qui retourne un boolÃ©en, sera utile !)

<center>![Supprimer un review](../../static/img/labo21/authorOnly.png)</center>

âŒ Le bouton pour supprimer un `Review` doit seulement Ãªtre visible pour l'auteur du `Review` ET pour tous les `corruptedTeacher`. (Comparez le pseudo dans le signal avec le nom de l'auteur du `Review`...)

Testez avec les quatre types d'utilisateurs (aucun rÃ´le, corruptedTeacher, student auteur et student pas auteur) si tous les Ã©lÃ©ments graphiques sont bien cachÃ©s au bon moment.

<center>
|Utilisateur|Mot de passe|RÃ´le|
|-|-|-|
|maxou|allo|corruptedTeacher|
|Pielle-Arexandre|allo|student|
|Masie-Carrandra|allo|student|
</center>

<center>ğŸ‘„ Merci d'avoir complÃ©tÃ© le dernier laboratoire ğŸ‘„</center>